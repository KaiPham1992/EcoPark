//
//  ParkingInfoViewController.swift
//  EnglishApp
//
//  Created Tu DV on 10/31/19.
//  Copyright © 2019 demo. All rights reserved.
//
//  Template generated by Juanpe Catalán @JuanpeCMiOS
//

import UIKit
import GooglePlaces

class ParkingInfoViewController: BaseViewController {

    @IBOutlet weak var tbParkingInfo: UITableView!
    @IBOutlet weak var lbActive: UILabel!
    @IBOutlet weak var vActive: CustomSwitch!
    
	var presenter: ParkingInfoPresenterProtocol?

    var isExplandParkingInfo = true
    var isExplandLicenseInfo = true
    
    var addressSelect: String = ""
    var isSelectAddress: Bool = false
    
    var parkingName: String = ""
    var parkingTypeID: String = ""
    var openTime: String = ""
    var closeTime: String = ""
    var parkingAddress: String = ""
    var listMaterial: [String] = []
    var codeTax: String = ""
    
    var listParkingType: [ParkingTypeEntity] = []
    var parkingInfo: ParkingInfoEntity? {
        didSet {
            tbParkingInfo.reloadData()
        }
    }
    
	override func viewDidLoad() {
        super.viewDidLoad()
        setTitleNavigation(title: "Thông tin bãi xe của tôi")
        addBackToNavigation()
        configTableView()
    }

    override func viewWillAppear(_ animated: Bool) {
        super.viewWillAppear(animated)
        presenter?.getParkingInfo(id: "2")
        presenter?.getListParkingType()
    }
    
    @IBAction func btnSaveTapped() {
        presenter?.updateInfoParking(param: UpdateInfoParkingParam(parking_id: "2", parking_address: parkingAddress, gpkd_img_before_src: parkingInfo?.gpkd_img_before_src, gpkd_img_after_src: parkingInfo?.gpkd_img_after_src, parking_name: parkingName, parking_type_id: parkingTypeID, number_place: parkingInfo?.number_place, time_start: openTime, time_end: closeTime, code_tax: codeTax, price: parkingInfo?.price, package_price: parkingInfo?.package_price, package_number: parkingInfo?.package_number, material: listMaterial))
    }
    
    @objc func imageParkingTapped() {
        
        
        guard let  listImage = parkingInfo?.img else { return }
        let listImageStr = listImage.map({ $0.img_src!})
        
        self.push(controller: ImageParkingRouter.createModule(listImage: listImageStr))
    }
    
}

extension ParkingInfoViewController: UITableViewDataSource, UITableViewDelegate {
    
    func configTableView() {
        tbParkingInfo.dataSource = self
        tbParkingInfo.delegate = self
        
        tbParkingInfo.registerXibFile(OtherInfoCell.self)
        tbParkingInfo.registerXibFile(SlideImageCell.self)
        tbParkingInfo.registerXibFile(ParkingInfoCell.self)
        tbParkingInfo.registerXibFile(LicenseInfoCell.self)
        
        tbParkingInfo.estimatedRowHeight = 200
        tbParkingInfo.rowHeight = UITableView.automaticDimension
    }
    
    func numberOfSections(in tableView: UITableView) -> Int {
        return 3
    }
    
    func tableView(_ tableView: UITableView, numberOfRowsInSection section: Int) -> Int {
        switch section {
        case 0:
            return 1
        case 1:
            if isExplandParkingInfo == true {
                return 2
            } else {
                return 0
            }
            
        default:
            if isExplandLicenseInfo == true {
                return 1
            } else {
                return 0
            }
        }
    }
    
    func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -> UITableViewCell {
        switch indexPath.section {
        case 0:
            let otherInfoCell = tableView.dequeueTableCell(OtherInfoCell.self)
            otherInfoCell.setData(parkingInfo: parkingInfo)
            return otherInfoCell
        case 1:
            if indexPath.row == 0 {
                let slideImageCell = tableView.dequeueTableCell(SlideImageCell.self)
                slideImageCell.setData(parkingInfo: parkingInfo)
                slideImageCell.btnCamera.addTarget(self, action: #selector(imageParkingTapped), for: .touchUpInside)
                return slideImageCell
            } else {
                let parkingInfoCell = tableView.dequeueTableCell(ParkingInfoCell.self)
                parkingInfoCell.setData(parkingInfo: parkingInfo, listItem: self.listParkingType.map({$0.name&}), isSelectAddress: isSelectAddress)
                parkingInfoCell.selectAddress = self.addressSelect
                parkingInfoCell.delegate = self
                return parkingInfoCell
            }
        default:
            let licenseInfoCell = tableView.dequeueTableCell(LicenseInfoCell.self)
            licenseInfoCell.setData(parkingInfo: parkingInfo)
            licenseInfoCell.delegate = self
            return licenseInfoCell
        }
    }
    
    func tableView(_ tableView: UITableView, heightForRowAt indexPath: IndexPath) -> CGFloat {
        switch indexPath.section {
        case 0:
            return 100
        case 1:
            if indexPath.row == 0 {
                return 215
            } else {
                return UITableView.automaticDimension
            }
        default:
            return 300
        }
    }
    
    func tableView(_ tableView: UITableView, viewForHeaderInSection section: Int) -> UIView? {
        switch section {
        case 0:
            return nil
        case 1:
            let headerView = HeaderInfoView()
            headerView.setupUI(title: LocalizableKey.parkingInfo.showLanguage.uppercased())
            headerView.delegate = self
            headerView.section = section
            headerView.setExpland(expland: isExplandParkingInfo)
            return headerView
            
        default:
            let headerView = HeaderInfoView()
            headerView.setupUI(title: LocalizableKey.parkingInfo.showLanguage.uppercased())
            headerView.delegate = self
            headerView.section = section
            headerView.setExpland(expland: isExplandLicenseInfo)
            return headerView
        }
    }
    
    func tableView(_ tableView: UITableView, heightForHeaderInSection section: Int) -> CGFloat {
        if section == 0 {
            return 0
        } else {
            return 50
        }
    }
}

extension ParkingInfoViewController: HeaderViewDelegate {
    func toggleSection(header: HeaderInfoView, section: Int) {
        if section == 1 {
            let expland = !isExplandParkingInfo
            isExplandParkingInfo = expland
            header.setExpland(expland: expland)
            let sectionExpland = IndexSet(integer: section)
            tbParkingInfo.reloadSections(sectionExpland, with: UITableView.RowAnimation.automatic)
        } else {
            let expland = !isExplandLicenseInfo
            isExplandLicenseInfo = expland
            header.setExpland(expland: expland)
            let sectionExpland = IndexSet(integer: section)
            tbParkingInfo.reloadSections(sectionExpland, with: .automatic)
        }
    }
    
}



extension ParkingInfoViewController: ParkingInfoViewProtocol {
    func didGetParkingInfo(parkingInfo: ParkingInfoEntity?) {
        self.parkingInfo = parkingInfo
        vActive.isOn = parkingInfo?.is_active ?? false ? true : false
    }
    
    func didGetListParkingType(listParkingType: [ParkingTypeEntity]) {
        self.listParkingType = listParkingType
    }
    
    func didUpdateInfoParking(parkingInfo: ParkingInfoEntity?) {
        presenter?.getParkingInfo(id: "2")
        tbParkingInfo.reloadData()
    }
}

extension ParkingInfoViewController: LicenseInfoCellDelegate {
    func getDataLicenseInfo(codeTax: String) {
        self.codeTax = codeTax
    }
}

extension ParkingInfoViewController: ParkingInfoCellDelegate {
    func getParkingInfo(parkingName: String, parkingTypeID: String, parkingAddress: String, openTime: String, closeTime: String, material: [String]) {
        
        self.parkingName = parkingName
        self.parkingTypeID = parkingTypeID
        if isSelectAddress {
            self.parkingAddress = addressSelect
        } else {
            self.parkingAddress = parkingAddress
        }
        self.openTime = openTime
        self.closeTime = closeTime
        self.listMaterial = material
    }
    
    func selectAddress() {
        let vcHomeFind = HomeFindRouter.createModule()
        vcHomeFind.delegate = self
        vcHomeFind.isSelectAddressSignUp = true
        self.push(controller: vcHomeFind)
    }
    
    
}

extension ParkingInfoViewController: HomeFindViewControllerDelegate {
    func didSelectMyLocation() {
        
    }
    
    func didSelectAddressSignUp(address: String, lat: CLLocationDegrees, long: CLLocationDegrees) {
        self.addressSelect = address
        self.isSelectAddress = true
        tbParkingInfo.reloadData()
    }
    
    func didSelectAddress(address: String, lat: CLLocationDegrees, long: CLLocationDegrees) {
    }
}
